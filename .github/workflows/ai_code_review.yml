name: Automated Code Review

on:
  # Triggers the workflow on every pull request event
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai_code_review:
    runs-on: ubuntu-latest
    
    # üí• CORRECTED INDENTATION FOR THE PERMISSIONS BLOCK üí•
    permissions:
      contents: read     # Required for Checkout
      pull-requests: write # Required to post status/checks
      issues: write      # Required to post comments to the PR (which is an issue)
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Cache Python Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: pip install -r requirements.txt
        
      - name: Fetch PR Diff
        id: fetch_diff
        run: |
          DIFF_CONTENT=$(git diff ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          # Use 'EOF' delimiter for multi-line content
          echo "DIFF_CONTENT<<EOF" >> $GITHUB_ENV
          echo "$DIFF_CONTENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Run AI Reviewer Script
        id: run_reviewer
        run: |
          REVIEW_COMMENT=$(python review_code.py "$DIFF_CONTENT")
          
          # Output the comment using the 'EOF' delimiter
          echo "REVIEW_COMMENT<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_COMMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post AI Review to PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const reviewComment = `${{ steps.run_reviewer.outputs.REVIEW_COMMENT }}`;
            
            // Post the comment if it's not an internal error message
            if (reviewComment && !reviewComment.startsWith("ERROR:")) {
                github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: reviewComment
                });
            } else {
                // Post a clear message if the review failed
                 github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: "‚ùå **Automated Review Failed:** The AI model encountered an error. Check job logs for details."
                });
                core.setFailed("AI Reviewer Script failed or returned an error message.");
            }